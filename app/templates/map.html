{% extends "base.html" %}
{% block title %}Checkpoint Map{% endblock %}
{% block content %}
<div class="d-flex align-items-end gap-3 mb-3">
  <div class="flex-grow-1">
    <label class="form-label">Team</label>
    <select id="teamSelect" class="form-select">
      <option value="">— Select a team —</option>
      {% for t in teams %}
        <option value="{{ t.id }}">{{ t.name }}{% if t.number %} ({{ t.number }}){% endif %}</option>
      {% endfor %}
    </select>
  </div>
  <div class="text-muted small">
    Legend:&nbsp;
    <span class="badge bg-success">found</span>
    <span class="badge bg-primary">next</span>
    <span class="badge bg-secondary">not&nbsp;found</span>
  </div>
</div>

<div id="map" style="height: 70vh; width: 100%; border-radius: 12px;"></div>

<script>
  // Colors for statuses
  const COLOR_FOUND = "#198754";     // bootstrap success
  const COLOR_NEXT = "#0d6efd";      // bootstrap primary
  const COLOR_NOT_FOUND = "#6c757d"; // bootstrap secondary

  let map;
  let markers = [];

  function clearMarkers() {
    for (const m of markers) m.setMap(null);
    markers = [];
  }

  // TEMP projection stub: converts (easting, northing) -> fake lat/lng for demo.
  // Replace with real projection (or store lat/lng) when ready.
  function toLatLng(easting, northing) {
    const originLat = 45.95;   // adjust to your area
    const originLng = 14.36;   // adjust to your area
    const scale = 0.00001;
    return {
      lat: originLat + (northing || 0) * scale,
      lng: originLng + (easting || 0) * scale
    };
  }

  async function getTargets(teamId) {
    const url = '{{ url_for("maps.api_team_targets") }}' + '?team_id=' + encodeURIComponent(teamId);
    const r = await fetch(url);
    if (!r.ok) throw new Error(await r.text());
    // Expected shape: [{checkpoint_id, name, easting, northing, status}]
    return await r.json();
  }

  function drawTargets(targets) {
    clearMarkers();
    if (!targets || !targets.length) return;

    // Compute a reasonable map center
    let sumLat = 0, sumLng = 0, count = 0;
    for (const cp of targets) {
      const pos = toLatLng(cp.easting, cp.northing);
      if (Number.isFinite(pos.lat) && Number.isFinite(pos.lng)) {
        sumLat += pos.lat; sumLng += pos.lng; count++;
      }
    }
    if (count > 0) {
      map.setCenter({ lat: sumLat / count, lng: sumLng / count });
    }

    for (const cp of targets) {
      const pos = toLatLng(cp.easting, cp.northing);
      const status = (cp.status || 'not_found').toLowerCase();
      const color = status === 'found' ? COLOR_FOUND
                   : status === 'next' ? COLOR_NEXT
                   : COLOR_NOT_FOUND;

      const marker = new google.maps.Marker({
        position: pos,
        map,
        title: `${cp.name} (${status})`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: color,
          fillOpacity: 1.0,
          strokeColor: color,
          strokeWeight: 1,
          scale: 6
        }
      });

      const info = new google.maps.InfoWindow({
        content: `
          <div>
            <strong>${cp.name}</strong><br>
            Status: <code>${status}</code><br>
            E: ${cp.easting ?? '—'}, N: ${cp.northing ?? '—'}
          </div>`
      });
      marker.addListener('click', () => info.open({ anchor: marker, map, shouldFocus: false }));
      markers.push(marker);
    }
  }

  async function refresh(teamId) {
    if (!teamId) { clearMarkers(); return; }
    const targets = await getTargets(teamId);
    drawTargets(targets);
  }

  async function init() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 45.95, lng: 14.36 },
      zoom: 12,
      mapTypeId: 'terrain'
    });

    // On change, pull team targets and redraw
    document.getElementById("teamSelect").addEventListener("change", (e) => {
      const teamId = e.target.value || "";
      refresh(teamId);
    });
  }
</script>

{% if google_maps_key %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=init"></script>
{% else %}
<script>
  // If no Google Maps key yet, still initialize to render markers with stubbed projection
  document.addEventListener("DOMContentLoaded", init);
</script>
{% endif %}
{% endblock %}