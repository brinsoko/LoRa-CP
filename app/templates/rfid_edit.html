{% extends "base.html" %}
{% block body %}
<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-3">Edit RFID Mapping</h5>

    <form method="post">
      <div class="mb-3">
        <label class="form-label">RFID UID</label>
        <input type="text" class="form-control" name="uid" value="{{ card.uid }}" required>
        <div class="form-text" id="nfcHelp">Paste or scan with Web NFC on supported devices.</div>
        <div class="d-flex align-items-center gap-2 mt-2">
          <button type="button" class="btn btn-outline-primary btn-sm" id="nfcReadBtn">Read via Web NFC</button>
          <span class="badge text-bg-secondary" id="nfcStatus">Not checked</span>
        </div>
        <div class="small text-body-secondary mt-2" id="nfcMessage"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Card Number (optional)</label>
        <input type="number" class="form-control" name="number" value="{{ card.number or '' }}">
      </div>

      <div class="mb-3">
        <label class="form-label">Assigned Team</label>
        <select name="team_id" class="form-select" required>
          {% for team in teams %}
            <option value="{{ team.id }}" {% if selected_team_id == team.id %}selected{% endif %}>
              {{ team.name }}{% if team.number %} ({{ team.number }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{{ url_for('rfid.list_rfid') }}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  const nfcBtn = document.getElementById("nfcReadBtn");
  const nfcStatus = document.getElementById("nfcStatus");
  const nfcMessage = document.getElementById("nfcMessage");
  const uidInput = document.querySelector('input[name="uid"]');
  const hasWebNfc = typeof NDEFReader !== "undefined";

  function setStatus(text, variant) {
    nfcStatus.textContent = text;
    nfcStatus.className = `badge text-bg-${variant}`;
  }

  function setMessage(text) {
    nfcMessage.textContent = text || "";
  }

  async function handleNfcRead() {
    setMessage("");
    if (!hasWebNfc) {
      setStatus("Unavailable", "secondary");
      setMessage("Web NFC not available in this browser.");
      return;
    }
    setStatus("Ready", "info");
    try {
      const reader = new NDEFReader();
      await reader.scan();
      setMessage("Hold the tag near your device to read.");

      const onRead = (event) => {
        reader.removeEventListener("reading", onRead);
        const uid = (event.serialNumber || "").toUpperCase();
        if (uid) {
          uidInput.value = uid;
          setStatus("Read", "success");
          setMessage(`UID read: ${uid}`);
        } else {
          setStatus("Failed", "danger");
          setMessage("Could not read UID from tag.");
        }
      };

      const onError = () => {
        reader.removeEventListener("reading", onRead);
        setStatus("Failed", "danger");
        setMessage("Web NFC read error.");
      };

      reader.addEventListener("reading", onRead, { once: true });
      reader.addEventListener("readingerror", onError, { once: true });
    } catch (err) {
      setStatus("Failed", "danger");
      setMessage(err?.message || "Web NFC not available.");
    }
  }

  if (hasWebNfc) {
    setStatus("Supported", "success");
  }
  nfcBtn?.addEventListener("click", handleNfcRead);
</script>
{% endblock %}
