{# app/templates/teams_list.html #}
{% extends "base.html" %}
{% block title %}{{ _('Teams') }}{% endblock %}
{% block content %}

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
        

      <div class="col-12 col-md-4">
        <label class="form-label">{{ _('Group') }}</label>
        <select name="group_id" class="form-select" id="groupSelect">
          <option value="">— {{ _('All groups') }} —</option>
          {% for g in groups %}
            <option value="{{ g.id }}" {% if selected_group_id == g.id %}selected{% endif %}>
              {{ g.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label">{{ _('Sort') }}</label>
        <select name="sort" class="form-select">
          <option value="name_asc"   {% if selected_sort == 'name_asc' %}selected{% endif %}>{{ _('Name (A→Z)') }}</option>
          <option value="name_desc"  {% if selected_sort == 'name_desc' %}selected{% endif %}>{{ _('Name (Z→A)') }}</option>
          <option value="number_asc" {% if selected_sort == 'number_asc' %}selected{% endif %}>{{ _('Number (↑)') }}</option>
          <option value="number_desc"{% if selected_sort == 'number_desc' %}selected{% endif %}>{{ _('Number (↓)') }}</option>
        </select>
      </div>

      <div class="col-12 d-flex gap-2 justify-content-md-end mt-2">
        <button class="btn btn-primary" type="submit">{{ _('Apply') }}</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('teams.list_teams') }}">{{ _('Reset') }}</a>
        {% if has_role('judge','admin') %}
          <a class="btn btn-success" href="{{ url_for('teams.add_team') }}">{{ _('Add Team') }}</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

{% if has_role('judge','admin') %}
  <div class="d-flex justify-content-end mb-3">
    <form method="post" action="{{ url_for('teams.randomize_numbers') }}" id="randomizeForm">
      <input type="hidden" name="group_id" id="randomizeGroupId" value="{{ selected_group_id or '' }}">
      <input type="hidden" name="next" value="{{ request.full_path }}">
      <button class="btn btn-outline-warning" type="submit" onclick="return confirm('{{ _('Randomise team numbers for the selected group?') }}');">
        {{ _('Randomise Team Numbers') }}
      </button>
    </form>
  </div>
{% endif %}

<div class="text-muted mb-2">{{ _('Total: %(count)s', count=teams|length) }}</div>

{% if teams|length == 0 %}
  <div class="alert alert-info">{{ _('No teams found.') }}</div>
{% else %}
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
      <thead>
        <tr>
          <th style="width:60px;">#</th>
          <th>{{ _('Name') }}</th>
          <th>{{ _('Rod / Org') }}</th>
          <th style="width:120px;">{{ _('Number') }}</th>
          <th>{{ _('Groups') }}</th>
          {% if has_role('judge','admin') %}
            <th class="text-end" style="width:180px;">{{ _('Actions') }}</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for team in teams %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ team.name }}</td>
            <td>{{ team.organization or "—" }}</td>
            <td>{{ team.number or "—" }}</td>

            <td>
              {% set assignment = team.group_assignments[0] if team.group_assignments else None %}
              {% if assignment and assignment.group %}
                <span class="badge bg-success">{{ assignment.group.name }}</span>
              {% else %}
                <span class="text-muted">{{ _('No group') }}</span>
              {% endif %}
            </td>

            {% if has_role('judge','admin') %}
              <td class="text-end">
                <a href="{{ url_for('teams.edit_team', team_id=team.id, next=request.full_path) }}"
                   class="btn btn-sm btn-outline-primary">{{ _('Edit') }}</a>
                {% if has_role('admin') %}
                <form action="{{ url_for('teams.delete_team', team_id=team.id) }}"
                      method="post" class="d-inline delete-team-form"
                      data-checkins="{{ team.checkins_count or 0 }}">
                  <input type="hidden" name="next" value="{{ request.full_path }}">
                  <input type="hidden" name="force" value="0">
                  <input type="hidden" name="confirm_text" value="">
                  <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
                </form>
                {% endif %}
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

{% if has_role('judge','admin') %}
<script>
  const groupSelect = document.getElementById("groupSelect");
  const randomizeForm = document.getElementById("randomizeForm");
  const randomizeGroupId = document.getElementById("randomizeGroupId");
  if (randomizeForm && groupSelect && randomizeGroupId) {
    randomizeForm.addEventListener("submit", () => {
      randomizeGroupId.value = groupSelect.value || "";
    });
  }

  const deleteForms = document.querySelectorAll(".delete-team-form");
  const deleteConfirm = "{{ _('Delete this team?') }}";
  const deletePrompt = "{{ _('This team has existing check-ins. Type Delete to confirm.') }}";
  const deleteWord = "Delete";
  deleteForms.forEach((form) => {
    form.addEventListener("submit", (event) => {
      if (!confirm(deleteConfirm)) {
        event.preventDefault();
        return;
      }
      const checkins = parseInt(form.dataset.checkins || "0", 10);
      if (checkins > 0) {
        const typed = prompt(deletePrompt) || "";
        if (typed !== deleteWord) {
          event.preventDefault();
          return;
        }
        const forceInput = form.querySelector("input[name='force']");
        const confirmInput = form.querySelector("input[name='confirm_text']");
        if (forceInput) forceInput.value = "1";
        if (confirmInput) confirmInput.value = typed;
      }
    });
  });
</script>
{% endif %}

{% endblock %}
