{% extends "base.html" %}
{% block body %}
<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-3">{{ _('Edit Team') }}</h5>
    <form method="post">
      <div class="mb-3">
        <label class="form-label">{{ _('Name') }}</label>
        <input name="name" class="form-control" value="{{ team.name }}" required>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('Rod / Org') }}</label>
        <input name="organization" class="form-control" value="{{ team.organization or '' }}" placeholder="{{ _('e.g. mGG / local org') }}">
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('Number') }}</label>
        <input type="number" name="number" class="form-control" value="{{ team.number if team.number is not none }}">
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('Group') }}</label>
        <select class="form-select" name="group_id">
          <option value="">— {{ _('No group') }} —</option>
          {% for g in groups %}
            <option value="{{ g.id }}" {% if selected_group_id == g.id %}selected{% endif %}>{{ g.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('RFID UID') }}</label>
        <input name="rfid_uid" class="form-control" value="{{ rfid_card.uid if rfid_card else '' }}" placeholder="{{ _('Tap tag or paste UID') }}">
        <div class="form-text">
          {{ _('Optional; saves an RFID mapping for this team.') }}
          {% if rfid_card %}
            <span class="ms-1 text-muted">{{ _('Current mapping ID') }}: {{ rfid_card.id }}</span>
          {% endif %}
        </div>
        <div class="d-flex align-items-center gap-2 mt-2">
          <button type="button" class="btn btn-outline-primary btn-sm" id="nfcReadBtn">{{ _('Read via Web NFC') }}</button>
          <span class="badge text-bg-secondary" id="nfcStatus">{{ _('Not checked') }}</span>
        </div>
        <div class="small text-body-secondary mt-2" id="nfcMessage"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('RFID Card Number') }}</label>
        <input type="number" name="rfid_number" class="form-control" value="{{ rfid_card.number if rfid_card else '' }}" placeholder="{{ _('Optional friendly number') }}">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit">{{ _('Save') }}</button>
        <a href="{{ url_for('teams.list_teams') }}" class="btn btn-secondary">{{ _('Cancel') }}</a>
      </div>
    </form>
  </div>
</div>

<script>
  const nfcBtn = document.getElementById("nfcReadBtn");
  const nfcStatus = document.getElementById("nfcStatus");
  const nfcMessage = document.getElementById("nfcMessage");
  const uidInput = document.querySelector('input[name="rfid_uid"]');
  const hasWebNfc = typeof NDEFReader !== "undefined";

  function setStatus(text, variant) {
    nfcStatus.textContent = text;
    nfcStatus.className = `badge text-bg-${variant}`;
  }

  function setMessage(text) {
    nfcMessage.textContent = text || "";
  }

  async function handleNfcRead() {
    setMessage("");
    if (!hasWebNfc) {
      setStatus("Unavailable", "secondary");
      setMessage("Web NFC not available in this browser.");
      return;
    }
    setStatus("Ready", "info");
    try {
      const reader = new NDEFReader();
      await reader.scan();
      setMessage("Hold the tag near your device to read.");

      const onRead = (event) => {
        reader.removeEventListener("reading", onRead);
        const uid = (event.serialNumber || "").toUpperCase();
        if (uid) {
          uidInput.value = uid;
          setStatus("Read", "success");
          setMessage(`UID read: ${uid}`);
        } else {
          setStatus("Failed", "danger");
          setMessage("Could not read UID from tag.");
        }
      };

      const onError = () => {
        reader.removeEventListener("reading", onRead);
        setStatus("Failed", "danger");
        setMessage("Web NFC read error.");
      };

      reader.addEventListener("reading", onRead, { once: true });
      reader.addEventListener("readingerror", onError, { once: true });
    } catch (err) {
      setStatus("Failed", "danger");
      setMessage(err?.message || "Web NFC not available.");
    }
  }

  if (hasWebNfc) {
    setStatus("Supported", "success");
  }
  nfcBtn?.addEventListener("click", handleNfcRead);
</script>
{% endblock %}
