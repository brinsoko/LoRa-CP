{% extends "base.html" %}
{% block body %}
<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-3">{{ _('Edit Team') }}</h5>
    <form method="post">
      <input type="hidden" name="next" value="{{ next_url or request.args.get('next', '') }}">
      <div class="mb-3">
        <label class="form-label">{{ _('Name') }}</label>
        <input name="name" class="form-control" value="{{ team.name }}" required>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('Rod / Org') }}</label>
        <input name="organization" class="form-control" value="{{ team.organization or '' }}" placeholder="{{ _('e.g. mGG / local org') }}" list="organizationList">
        <datalist id="organizationList">
          {% for org in organizations or [] %}
            <option value="{{ org }}"></option>
          {% endfor %}
        </datalist>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('Number') }}</label>
        <input type="number" name="number" class="form-control" value="{{ team.number if team.number is not none }}">
        <div class="form-text">{{ _('Optional; can be assigned later.') }}</div>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('Group') }}</label>
        <select class="form-select" name="group_id">
          <option value="">— {{ _('No group') }} —</option>
          {% for g in groups %}
            <option value="{{ g.id }}" {% if selected_group_id == g.id %}selected{% endif %}>{{ g.name }}</option>
          {% endfor %}
        </select>
      </div>

      {% if current_competition_role == 'admin' %}
      <div class="mb-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="dnf" name="dnf" value="1" {% if team.dnf %}checked{% endif %}>
          <label class="form-check-label" for="dnf">{{ _('DNF (Did Not Finish)') }}</label>
        </div>
      </div>
      {% endif %}

      <div class="mb-3">
        <label class="form-label">{{ _('RFID UID') }}</label>
        <input name="rfid_uid" class="form-control" value="{{ rfid_card.uid if rfid_card else '' }}" placeholder="{{ _('Tap tag or paste UID') }}">
        <div class="form-text">
          {{ _('Optional; saves an RFID mapping for this team.') }}
          {% if rfid_card %}
            <span class="ms-1 text-muted">{{ _('Current mapping ID') }}: {{ rfid_card.id }}</span>
          {% endif %}
        </div>
        <div class="d-flex align-items-center gap-2 mt-2">
          <button type="button" class="btn btn-outline-primary btn-sm" id="nfcReadBtn">{{ _('Read via Web NFC') }}</button>
          <span class="badge text-bg-secondary" id="nfcStatus">{{ _('Not checked') }}</span>
        </div>
        <div class="small text-body-secondary mt-2" id="nfcMessage"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ _('RFID Card Number') }}</label>
        <input type="number" name="rfid_number" class="form-control" value="{{ rfid_card.number if rfid_card else '' }}" placeholder="{{ _('Optional friendly number') }}">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit">{{ _('Save') }}</button>
        <a href="{{ url_for('teams.list_teams') }}" class="btn btn-secondary">{{ _('Cancel') }}</a>
      </div>
    </form>
  </div>
</div>

<script>
  const nfcBtn = document.getElementById("nfcReadBtn");
  const nfcStatus = document.getElementById("nfcStatus");
  const nfcMessage = document.getElementById("nfcMessage");
  const uidInput = document.querySelector('input[name="rfid_uid"]');
  const hasWebNfc = typeof NDEFReader !== "undefined";
  const i18n = {
    unavailable: {{ _('Unavailable')|tojson }},
    ready: {{ _('Ready')|tojson }},
    read: {{ _('Read')|tojson }},
    failed: {{ _('Failed')|tojson }},
    supported: {{ _('Supported')|tojson }},
    webNfcNotAvailableInBrowser: {{ _('Web NFC not available in this browser.')|tojson }},
    holdTagNearDevice: {{ _('Hold the tag near your device to read.')|tojson }},
    uidReadPrefix: {{ _('UID read:')|tojson }},
    uidReadFailed: {{ _('Could not read UID from tag.')|tojson }},
    webNfcReadError: {{ _('Web NFC read error.')|tojson }},
    webNfcNotAvailable: {{ _('Web NFC not available.')|tojson }},
  };

  function setStatus(text, variant) {
    nfcStatus.textContent = text;
    nfcStatus.className = `badge text-bg-${variant}`;
  }

  function setMessage(text) {
    nfcMessage.textContent = text || "";
  }

  async function handleNfcRead() {
    setMessage("");
    if (!hasWebNfc) {
      setStatus(i18n.unavailable, "secondary");
      setMessage(i18n.webNfcNotAvailableInBrowser);
      return;
    }
    setStatus(i18n.ready, "info");
    try {
      const reader = new NDEFReader();
      await reader.scan();
      setMessage(i18n.holdTagNearDevice);

      const onRead = (event) => {
        reader.removeEventListener("reading", onRead);
        const uid = (event.serialNumber || "").toUpperCase();
        if (uid) {
          uidInput.value = uid;
          setStatus(i18n.read, "success");
          setMessage(`${i18n.uidReadPrefix} ${uid}`);
        } else {
          setStatus(i18n.failed, "danger");
          setMessage(i18n.uidReadFailed);
        }
      };

      const onError = () => {
        reader.removeEventListener("reading", onRead);
        setStatus(i18n.failed, "danger");
        setMessage(i18n.webNfcReadError);
      };

      reader.addEventListener("reading", onRead, { once: true });
      reader.addEventListener("readingerror", onError, { once: true });
    } catch (err) {
      setStatus(i18n.failed, "danger");
      setMessage(err?.message || i18n.webNfcNotAvailable);
    }
  }

  if (hasWebNfc) {
    setStatus(i18n.supported, "success");
  }
  nfcBtn?.addEventListener("click", handleNfcRead);
</script>
{% endblock %}
