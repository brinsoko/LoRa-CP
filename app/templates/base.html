<!doctype html>
<html lang="{{ current_locale }}" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}{{ _('RFID Checkpoint System') }}{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Initialize theme early (avoid flash) -->
  <script>
    (function() {
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-bs-theme', theme);
      } catch (e) {}
    })();
  </script>

  <style>
    [data-bs-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) > * {
      --bs-table-accent-bg: rgba(255,255,255,.03);
      color: inherit;
    }
    .theme-toggle { display: inline-flex; align-items: center; gap: .5rem; }

  [data-bs-theme="dark"] .form-check-label { color: var(--bs-body-color); }
  [data-bs-theme="dark"] .form-text { color: var(--bs-secondary-color); }

  </style>
</head>

<body class="p-4">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary mb-4 rounded-3 px-3">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
        {{ _('RFID Checkpoint System') }}
      </a>

      <div class="ms-auto d-flex align-items-center gap-2">
        {% if current_user.is_authenticated %}
          <span class="text-body-secondary">
            {{ _('Signed in as %(user)s (%(role)s)', user=current_user.username, role=current_user.role) }}
          </span>
          <form method="post" action="{{ url_for('auth.logout') }}" class="d-inline">
            <button class="btn btn-sm btn-outline-danger">{{ _('Logout') }}</button>
          </form>
          <a href="{{ url_for('auth.change_password') }}" class="btn btn-sm btn-outline-secondary">
            {{ _('Change Password') }}
          </a>
        {% else %}
          <a href="{{ url_for('auth.login') }}" class="btn btn-sm btn-outline-primary">{{ _('Login') }}</a>
        {% endif %}
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <a href="{{ url_for('auth.register') }}" class="btn btn-sm btn-outline-success">{{ _('Create User') }}</a>
        {% endif %}
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <li class="nav-item">
            <a href="{{ url_for('users.list_users') }}" class="btn btn-sm btn-outline-secondary">{{ _('Users') }}</a>
        {% endif %}

        <!-- THEME TOGGLE -->
         <div class="theme-toggle bg-body-tertiary border rounded-3 px-3 py-2 shadow">
          <label class="form-check-label" for="themeSwitch">{{ _('Dark mode') }}</label>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch" />
            </div>
          </div>

        <!-- LANGUAGE PICKER -->
        {% if languages %}
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              {{ languages.get(current_locale, current_locale) }}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              {% for code, label in languages.items() %}
                <li>
                  <a class="dropdown-item {% if code == current_locale %}active{% endif %}"
                     href="{{ url_for('main.set_language', lang_code=code, next=request.full_path) }}">
                    {{ label }}
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        

   

    </div>
  </nav>

  <!-- ACTION BAR -->
  <div class="mb-3 d-flex flex-wrap gap-2">


    <a href="{{ url_for('teams.list_teams') }}" class="btn btn-outline-primary">{{ _('Teams') }}</a>
    

    {% if current_user.is_authenticated and current_user.role in ['judge','admin'] %}
      <a href="{{ url_for('checkpoints.list_checkpoints') }}" class="btn btn-outline-secondary">{{ _('Checkpoints') }}</a>
      

      
      <a href="{{ url_for('checkins.list_checkins') }}" class="btn btn-outline-info">{{ _('View Check-ins') }}</a>
      <a href="{{ url_for('checkins.add_checkin') }}" class="btn btn-success">{{ _('Add Check-in') }}</a>

      <a href="{{ url_for('rfid.list_rfid') }}" class="btn btn-outline-info">{{ _('Map RFID ↔ Team') }}</a>
      <a href="{{ url_for('rfid.judge_console') }}" class="btn btn-outline-primary">{{ _('Judge RFID') }}</a>
      <a href="{{ url_for('rfid.finish_console') }}" class="btn btn-outline-success">{{ _('Finish Check') }}</a>

      <a href="{{ url_for('groups.list_groups') }}" class="btn btn-outline-secondary">{{ _('Groups') }}</a>
      <a href="{{ url_for('lora.lora_list') }}" class="btn btn-outline-secondary">{{ _('Devices') }}</a>
      {# Only show if the endpoint exists in your blueprint #}
      {% if 'groups.assign_team_group' in current_app.view_functions %}
        <a href="{{ url_for('groups.assign_team_group') }}" class="btn btn-outline-secondary">{{ _('Assign Team → Group') }}</a>
      {% endif %}
      {% if current_user.is_authenticated and current_user.role == 'admin' %}

          <a class="btn btn-outline-secondary" href="{{ url_for('messages.list_messages') }}">{{ _('Messages') }}</a>

      {% endif %}
      <a href="{{ url_for('maps.index') }}" class="btn btn-outline-primary">{{ _('Map') }}</a>
      <a href="{{ url_for('maps.lora_map') }}" class="btn btn-outline-primary">{{ _('Device Map') }}</a>
      {% if current_user.is_authenticated and current_user.role == 'admin' %}
      <a href="{{ url_for('sheets_admin.list_sheets') }}" class="btn btn-outline-secondary">{{ _('Sheets') }}</a>
      {% endif %}
    {% endif %}
    
  </div>

  <!-- FLASH MESSAGES -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ 'warning' if category=='warning' else category }} mb-2">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- PAGE CONTENT -->
  <main>
    {# Preferred new block #}
    {% block content %}
      {# Backwards-compat: render legacy block=body inside content #}
      {% block body %}{% endblock %}
    {% endblock %}
  </main>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Theme Sync Script -->
  <script>
    (function () {
      const el = document.getElementById('themeSwitch');
      if (!el) return;
      const current = document.documentElement.getAttribute('data-bs-theme') || 'light';
      el.checked = (current === 'dark');

      el.addEventListener('change', function () {
        const next = this.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-bs-theme', next);
        try { localStorage.setItem('theme', next); } catch (e) {}
      });

      window.addEventListener('storage', function (e) {
        if (e.key === 'theme') {
          const v = e.newValue || 'light';
          document.documentElement.setAttribute('data-bs-theme', v);
          el.checked = (v === 'dark');
        }
      });
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>



</html>
