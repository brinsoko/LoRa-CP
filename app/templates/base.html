<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}RFID Checkpoint System{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Initialize theme early -->
  <script>
    (function() {
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-bs-theme', theme);
      } catch (e) {}
    })();
  </script>

  <style>
    [data-bs-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) > * {
      --bs-table-accent-bg: rgba(255,255,255,.03);
      color: inherit;
    }
    .theme-toggle { display: inline-flex; align-items: center; gap: .5rem; }
  </style>
</head>

<body class="p-4">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary mb-4 rounded-3 px-3">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
        RFID Checkpoint System
      </a>

      <div class="ms-auto d-flex align-items-center gap-2">
        {% if current_user.is_authenticated %}
          <span class="text-body-secondary">
            Signed in as <strong>{{ current_user.username }}</strong> ({{ current_user.role }})
          </span>
          <form method="post" action="{{ url_for('auth.logout') }}" class="d-inline">
            <button class="btn btn-sm btn-outline-danger">Logout</button>
          </form>
          <a href="{{ url_for('auth.change_password') }}" class="btn btn-sm btn-outline-secondary">
            Change Password
          </a>
        {% else %}
          <a href="{{ url_for('auth.login') }}" class="btn btn-sm btn-outline-primary">Login</a>
        {% endif %}
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <a href="{{ url_for('auth.register') }}" class="btn btn-sm btn-outline-warning">
            Create User
          </a>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- ACTION BAR -->
  <div class="mb-3 d-flex flex-wrap gap-2">
    {% if current_user.is_authenticated and current_user.role in ['judge','admin'] %}
      <a href="{{ url_for('teams.add_team') }}" class="btn btn-primary">Add Team</a>
    {% endif %}
    <a href="{{ url_for('teams.list_teams') }}" class="btn btn-outline-primary">Manage Teams</a>
    <a href="{{ url_for('rfid.public_mappings') }}" class="btn btn-outline-info">RFID Mappings</a>
    <a href="{{ url_for('maps.index') }}" class="btn btn-outline-primary">Map</a>

    {% if current_user.is_authenticated and current_user.role in ['judge','admin'] %}
      <a href="{{ url_for('checkpoints.add_checkpoint') }}" class="btn btn-secondary">Add Checkpoint</a>
      <a href="{{ url_for('checkpoints.list_checkpoints') }}" class="btn btn-outline-secondary">Manage Checkpoints</a>
      <a href="{{ url_for('checkpoints.import_checkpoints_json') }}" class="btn btn-outline-secondary">Import Checkpoints (JSON)</a>

      <a href="{{ url_for('checkins.add_checkin') }}" class="btn btn-success">Add Check-in</a>
      <a href="{{ url_for('checkins.list_checkins') }}" class="btn btn-outline-info">View Check-ins</a>

      <a href="{{ url_for('rfid.add_rfid') }}" class="btn btn-outline-info">Map RFID ↔ Team</a>
      <a href="{{ url_for('rfid.rfid_upload_csv_form') }}" class="btn btn-outline-info">Upload RFID CSV</a>
      <a href="{{ url_for('groups.list_groups') }}" class="btn btn-outline-secondary">Groups</a>
      <a href="{{ url_for('groups.assign_team_group') }}" class="btn btn-outline-secondary">Assign Team → Group</a>
    {% endif %}
  </div>

  <!-- FLASH MESSAGES -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ 'warning' if category=='warning' else category }} mb-2">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- PAGE CONTENT -->
  <main>
    {% block content %}{% endblock %}
  </main>

  <!-- THEME TOGGLE -->
  <div class="position-fixed bottom-0 end-0 p-3">
    <div class="theme-toggle bg-body-tertiary border rounded-3 px-3 py-2 shadow">
      <label class="form-check-label" for="themeSwitch">Dark mode</label>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch" />
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Theme Sync Script -->
  <script>
    (function () {
      const el = document.getElementById('themeSwitch');
      if (!el) return;
      const current = document.documentElement.getAttribute('data-bs-theme') || 'light';
      el.checked = (current === 'dark');

      el.addEventListener('change', function () {
        const next = this.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-bs-theme', next);
        try { localStorage.setItem('theme', next); } catch (e) {}
      });

      window.addEventListener('storage', function (e) {
        if (e.key === 'theme') {
          const v = e.newValue || 'light';
          document.documentElement.setAttribute('data-bs-theme', v);
          el.checked = (v === 'dark');
        }
      });
    })();
  </script>
</body>
</html>