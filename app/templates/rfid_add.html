{% extends "base.html" %}
{% block title %}Add RFID Card{% endblock %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-3">Add RFID Card</h5>

    <form method="post" id="rfidForm" novalidate>
      <div class="mb-3">
        <label class="form-label">RFID UID</label>
        <div class="input-group">
          <input type="text" class="form-control" name="uid" id="uidInput"
                 value="{{ uid_value or '' }}"
                 placeholder="Enter RFID UID" required>
          <!-- Optional: scan button (works if serial reader is connected & endpoint enabled) -->
          <button class="btn btn-outline-secondary" type="button" id="scanBtn">Scan UID</button>
          <button class="btn btn-outline-primary" type="button" id="webNfcBtn">Web NFC</button>
        </div>
        <div class="form-text">UID is case-insensitive; colons/dashes are OK. Web NFC works on Android Chrome.</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Card Number (optional)</label>
        <input type="number" class="form-control" name="number" id="numberInput"
               inputmode="numeric" min="1" step="1" placeholder="e.g. 101"
               value="{{ number_value or '' }}">
        <div class="form-text">Must be a positive integer if provided.</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Assign to Team</label>
        <select name="team_id" class="form-select" required>
          <option value="">— Select Team —</option>
          {% for team in teams %}
            <option value="{{ team.id }}" {% if selected_team_id == team.id %}selected{% endif %}>{{ team.name }}{% if team.number %} ({{ team.number }}){% endif %}</option>
          {% endfor %}
        </select>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Add RFID</button>
        <a href="{{ url_for('rfid.list_rfid') }}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  // Optional: call /rfid/scan_once and fill the UID field
  (function () {
    const btn = document.getElementById('scanBtn');
    const uidInput = document.getElementById('uidInput');
    if (!btn) return;
    btn.addEventListener('click', async function () {
      btn.disabled = true;
      btn.textContent = 'Scanning…';
      try {
        const resp = await fetch('{{ url_for("rfid.rfid_scan_once") }}', {method: 'POST'});
        const data = await resp.json();
        if (data && data.ok && data.uid) {
          uidInput.value = data.uid;
        } else {
          alert(data && data.error ? data.error : 'No UID read.');
        }
      } catch (e) {
        alert('Scan failed. Is the reader connected?');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Scan UID';
      }
    });
  })();

  // Web NFC UID read (Android Chrome)
  (function () {
    const btn = document.getElementById('webNfcBtn');
    const uidInput = document.getElementById('uidInput');
    if (!btn || typeof NDEFReader === 'undefined') {
      if (btn) btn.disabled = true;
      return;
    }
    btn.addEventListener('click', async function () {
      btn.disabled = true;
      btn.textContent = 'Tap tag...';
      try {
        const reader = new NDEFReader();
        await reader.scan();
        reader.onreading = (event) => {
          const serial = (event.serialNumber || '').toUpperCase();
          if (serial) {
            uidInput.value = serial;
          }
          btn.textContent = 'Web NFC';
          btn.disabled = false;
        };
        reader.onreadingerror = () => {
          alert('Web NFC read error.');
          btn.textContent = 'Web NFC';
          btn.disabled = false;
        };
      } catch (err) {
        alert(err && err.message ? err.message : 'Web NFC not available.');
        btn.textContent = 'Web NFC';
        btn.disabled = false;
      }
    });
  })();

  // Light client-side guard for positive number (server still validates)
  (function () {
    const f = document.getElementById('rfidForm');
    const numberInput = document.getElementById('numberInput');
    if (!f) return;
    f.addEventListener('submit', function (e) {
      const v = numberInput.value.trim();
      if (v !== '') {
        const n = Number(v);
        if (!Number.isInteger(n) || n <= 0) {
          e.preventDefault();
          alert('Card number must be a positive integer (or leave blank).');
        }
      }
    });
  })();
</script>
{% endblock %}
